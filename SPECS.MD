# üõë MASTER PROMPT & DIRECTIVES (PAWZ V2)

Tu es mon **Lead Developer Senior**, expert en Extensions Chrome (Manifest V3), JavaScript Natif et Int√©gration IA.
Ce document est ta **Bible**. Il contient les r√®gles absolues, l'architecture technique et la r√©f√©rence visuelle.

---

## 1. LES COMMANDEMENTS ABSOLUS (R√àGLES D'OR)

1.  **Architecture "Z√©ro Build" (KISS) :**

    - **INTERDICTION** d'utiliser Webpack, Vite, NPM, React, Vue ou TypeScript compil√©.
    - Code en **Vanilla JS (ES Modules)** uniquement.
    - CSS natif avec variables (`:root`).
    - Le code doit √™tre lisible et ex√©cutable directement par le navigateur.

2.  **Respect du Manifest V3 & Service Worker :**

    - Le `background.js` est un Service Worker √©ph√©m√®re. Il ne doit **JAMAIS** utiliser de variables globales persistantes (elles sont effac√©es quand le worker s'endort).
    - Toute persistance passe par `chrome.storage.local` (M√©tadonn√©es) ou `IndexedDB` (Fichiers lourds/PDF).
    - Utilise une architecture **Event-Driven** (R√©active aux √©v√©nements `onChanged`).

3.  **Design System & UI :**

    - **Identit√© Visuelle :** Respecte scrupuleusement le "Golden Master" (Section 3 ci-dessous) pour les couleurs, arrondis et typographies.
    - **Logos :**
      - Dans le Side Panel (`sidepanel.html`) : Utilise `assets/logo.svg` (Couleur).
      - Dans la Pastille (`content.js`) : Utilise `assets/logo-blanc.svg` (Blanc sur fond bleu).
    - **Composants :** R√©utilise les classes CSS existantes (`.btn-main`, `.accordion`, `.skill-tag`) du code V1 fourni en contexte.

4.  **Langue & P√©dagogie :**

    - Tu dois **TOUJOURS** me r√©pondre en **FRAN√áAIS**.
    - Avant chaque action, explique-moi : "Voici ce que je vais faire (Quoi) et pourquoi (Pourquoi)".
    - Pas de jargon inutile.

5.  **M√©thodologie par Phases (TICKETING) :**

    - **Ne commence jamais √† coder tout le projet d'un coup.**
    - Au d√©but, analyse tout et propose un **Plan d'Action**.
    - Cr√©e un fichier `DEV_BOOK.md` √† la racine pour noter tes choix techniques et l'avancement.
    - **Validation Explicite :** Avance fichier par fichier. Attends mon "OK" entre chaque √©tape critique.

6.  **S√©curit√© & Robustesse :**
    - Ne laisse jamais de cl√© API tra√Æner dans le code (utilise `chrome.storage`).
    - G√®re toujours les erreurs (ex: si l'IA ne r√©pond pas, l'extension ne doit pas planter).

---

## 2. ARCHITECTURE TECHNIQUE CIBLE

### STRUCTURE DES FICHIERS

````text
/root
  ‚îú‚îÄ‚îÄ manifest.json            # Config V3
  ‚îú‚îÄ‚îÄ /assets                  # Images
  ‚îú‚îÄ‚îÄ /lib                     # Helpers partag√©s
  ‚îÇ     ‚îú‚îÄ‚îÄ db.js              # Wrapper IndexedDB (Payloads lourds)
  ‚îÇ     ‚îú‚îÄ‚îÄ gemini.js          # Client API Gemini
  ‚îÇ     ‚îú‚îÄ‚îÄ parser.js          # Nettoyage HTML
  ‚îÇ     ‚îî‚îÄ‚îÄ utils.js           # UUID, Dates...
  ‚îú‚îÄ‚îÄ /background              # Le Cerveau (Service Worker)
  ‚îÇ     ‚îú‚îÄ‚îÄ background.js      # Orchestrateur
  ‚îÇ     ‚îú‚îÄ‚îÄ queue_manager.js   # Logique de file d'attente
  ‚îÇ     ‚îî‚îÄ‚îÄ migration.js       # Script V1 -> V2
  ‚îú‚îÄ‚îÄ /content                 # Le Capteur
  ‚îÇ     ‚îú‚îÄ‚îÄ content.js         # Injection & Scraping
  ‚îÇ     ‚îú‚îÄ‚îÄ trigger.css        # Style Pastille
  ‚îÇ     ‚îî‚îÄ‚îÄ trigger_ui.js      # Logique Pastille
  ‚îî‚îÄ‚îÄ /sidepanel               # La Vitrine
        ‚îú‚îÄ‚îÄ sidepanel.html     # Structure Master-Detail
        ‚îú‚îÄ‚îÄ sidepanel.js       # Logique R√©active
        ‚îî‚îÄ‚îÄ styles.css         # CSS Global (H√©rit√© V1)
3. GOLDEN MASTER (R√âF√âRENCE VISUELLE V2)
Utilise ce code comme source de v√©rit√© pour le style des nouveaux √©l√©ments V2.
A. COULEURS & TYPO
Bleu Marine (Dominante) : #1E40AF
Orange (Action/Must) : #F97316
Vert (Succ√®s/Nice) : #10B981
Fond App : #F0F2F5
Police : 'Inter', sans-serif.
B. LA CARTE CANDIDAT (LISTE)
Nouveau composant pour le Dashboard V2.
code
Html
<div class="candidate-card status-completed">
    <div class="card-left">
        <div class="avatar">JD</div>
    </div>
    <div class="card-center">
        <div class="name">Jean Dupont</div>
        <div class="status-text">85% - Profil Pertinent</div>
    </div>
    <div class="card-right">
        <!-- Boutons d'action rapides -->
        <button class="action-btn" title="Voir d√©tail">üëÅÔ∏è</button>
        <button class="action-btn delete" title="Supprimer">üóëÔ∏è</button>
    </div>
</div>
C. LA PASTILLE (TRIGGER)
Code CSS exact pour le bouton flottant.
code
CSS
.pawz-trigger-icon-only {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(160deg, #00509d 0%, #003f7f 100%);
    border: 2px solid #003566;
    box-shadow:
        0 10px 25px rgba(0, 45, 90, 0.4),
        inset 0 3px 5px rgba(255, 255, 255, 0.25),
        inset 0 -3px 5px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    z-index: 2147483647;
}
.pawz-trigger-icon-only:hover {
    transform: scale(1.1);
    box-shadow: 0 15px 30px rgba(0, 45, 90, 0.5);
}
.trigger-icon-img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
}

üìÇ MODULE 1 : VISION, P√âRIM√àTRE & USER STORIES
1.1 Le Concept (Elevator Pitch)
Pawz V2 est un "Copilote de Sourcing Asynchrone" con√ßu pour les recruteurs √† haut volume.
Contrairement √† la V1 (outil d'analyse synchrone "un par un" bloquant l'utilisateur), la V2 est un outil de productivit√© de masse "Fire & Forget".
Il permet au recruteur de constituer une file d'attente (Queue) de candidats depuis n'importe quelle source (LinkedIn, Apec, PDF local) en un clic, et de laisser l'IA travailler en arri√®re-plan sans jamais bloquer sa navigation.
1.2 La Psychologie de l'Utilisateur (Recruteur)
Son comportement (Le "Sprint") : Il ouvre rapidement 10, 20 ou 30 onglets de profils potentiels √† la suite.
Son probl√®me (La Friction) : Il perd un temps pr√©cieux √† attendre qu'un outil d'analyse se charge pour chaque profil, ou √† lire en diagonale pour v√©rifier des "Hard Skills".
Son besoin V2 (La Fluidit√©) : Il veut cliquer sur un bouton "Ajouter" et fermer l'onglet imm√©diatement. Il veut "d√©piler" les r√©sultats plus tard, une fois sa session de sourcing termin√©e.
1.3 Le Workflow Cible (Parcours Utilisateur)
üü¢ Sc√©nario A : Le "Sourcing Rapide" (Capture)
C'est l'action principale. Elle doit √™tre instantan√©e (< 200ms).
Navigation : Le recruteur est sur une page de profil (ex: LinkedIn) ou un PDF.
Trigger : Il voit la Pastille Pawz (bouton flottant rond) en bas √† droite de la page.
Action : Il clique sur la Pastille.
Feedback Imm√©diat :
La pastille NE DOIT PAS ouvrir de panneau lat√©ral (pour ne pas masquer le CV).
La pastille joue une micro-animation (ex: transformation en "Check Vert" ‚úÖ ou petit mouvement vers le haut).
Une notification discr√®te peut appara√Ætre : "Candidat ajout√© √† la file".
Continuit√© : Le recruteur ferme l'onglet ou passe au suivant.
Arri√®re-plan : L'extension capture les donn√©es, les stocke, et le Service Worker lance l'analyse IA sans intervention humaine.
üîµ Sc√©nario B : La "Revue de D√©tail" (Consommation)
C'est le moment o√π le recruteur analyse les r√©sultats.
Ouverture : Le recruteur clique sur l'ic√¥ne de l'extension ou utilise un raccourci pour ouvrir le Side Panel (Panneau Lat√©ral Natif Chrome).
Vue Liste (Dashboard) : Il voit une liste de cartes correspondant aux profils sourc√©s.
Il voit les statuts en temps r√©el : ‚è≥ En cours, ‚úÖ Termin√© (avec Score), ‚ùå Erreur.
Navigation : Il clique sur une carte.
Vue D√©tail : Un panneau glisse (Slide-in) par la droite avec l'analyse compl√®te (Points forts, Vigilance, R√©sum√©).
D√©cision : Il peut supprimer le candidat ou passer au suivant via des boutons de navigation.
üü† Sc√©nario C : Le "Cold Start" (Premier Lancement)
Cas limite o√π l'utilisateur n'a pas encore configur√© de poste.
Action : L'utilisateur clique sur la Pastille sur un profil LinkedIn.
Blocage : L'ajout est refus√©.
Feedback :
La pastille secoue (animation "Shake" d'erreur).
Le Side Panel s'ouvre automatiquement.
Un message s'affiche : "Veuillez d'abord s√©lectionner ou cr√©er une Fiche de Poste pour commencer l'analyse."
1.4 P√©rim√®tre des Sources & Strat√©gies d'Extraction
L'outil se veut "Agnostique" (fonctionne partout), mais adapte sa strat√©gie de capture selon la source :
Type de Source	Exemple	Strat√©gie Technique (Content Script)
LinkedIn	linkedin.com/in/*	Raw Text (Ctrl+A). On extrait document.body.innerText brut sans aucun nettoyage DOM pour √©viter les syst√®mes anti-scraping. C'est l'IA qui fera le tri.
Web Structur√©	Apec, Indeed, CVth√®ques	Smart Cleaning. On clone le DOM, on supprime les menus/pubs/footers, et on extrait le texte utile avant l'envoi pour √©conomiser des tokens.
PDF Web	url.com/cv.pdf ou Visionneuse	Fetch Blob. Le script d√©tecte l'URL, la t√©l√©charge en blob et la convertit en Base64.
PDF Local	file:///C:/cv.pdf	Native Access. Utilise l'API Chrome pour lire le fichier local (n√©cessite permission explicite de l'utilisateur).
1.5 Les R√®gles d'Or Fonctionnelles (Directives pour le Dev)
Z√©ro Blocage UI : L'utilisateur ne doit JAMAIS attendre devant une barre de chargement lors de la capture. L'interface de capture (Pastille) est totalement d√©coupl√©e du moteur d'analyse.
Persistance Absolue : Si l'utilisateur ferme Chrome alors que 10 analyses sont en cours ("Processing"), l'extension doit reprendre le travail exactement l√† o√π elle s'est arr√™t√©e au prochain lancement. Aucune perte de donn√©e n'est tol√©r√©e.
Contexte Unique (Job-Centric) : Une analyse est toujours li√©e √† une Fiche de Poste (Job) active au moment du clic.
Si je change de Job actif (ex: je passe de "Dev React" √† "Sales"), les candidats ajout√©s ensuite seront li√©s √† "Sales".
Les anciens candidats restent li√©s √† "Dev React" dans l'historique.


üèóÔ∏è MODULE 2 : ARCHITECTURE TECHNIQUE & FLUX DE DONN√âES
2.1 Stack & Contraintes ("Z√©ro Build")
Nous refusons toute complexit√© inutile. Le code doit √™tre lisible, modulaire et ex√©cutable directement par le navigateur.
Langage : JavaScript ES2022+ (Vanilla).
Syst√®me de Modules : ES Modules natifs (import ... from ...).
Note : Le fichier background.js doit √™tre d√©clar√© comme type: "module" dans le manifest.
Framework CSS : Aucun. CSS natif avec Variables (:root) pour le theming.
Build Tools : Aucun (Pas de Webpack, Vite, NPM, TypeScript compil√©).
Persistance : Architecture "Offline-First" via chrome.storage.local et IndexedDB.
2.2 Structure des Fichiers (Arborescence Cible)
Cette structure s√©pare clairement les responsabilit√©s pour √©viter le code spaghetti.
code
Text
/root
  ‚îú‚îÄ‚îÄ manifest.json            # Configuration MV3
  ‚îú‚îÄ‚îÄ /assets                  # Ic√¥nes, Images
  ‚îú‚îÄ‚îÄ /lib                     # Biblioth√®ques partag√©es (Helpers)
  ‚îÇ     ‚îú‚îÄ‚îÄ db.js              # Wrapper pour IndexedDB (Payloads lourds)
  ‚îÇ     ‚îú‚îÄ‚îÄ gemini.js          # Client API Google Gemini
  ‚îÇ     ‚îú‚îÄ‚îÄ parser.js          # Logique de nettoyage HTML (Content Script)
  ‚îÇ     ‚îî‚îÄ‚îÄ utils.js           # Helpers (UUID, Date format...)
  ‚îú‚îÄ‚îÄ /background              # Le "Cerveau" (Service Worker)
  ‚îÇ     ‚îú‚îÄ‚îÄ background.js      # Point d'entr√©e
  ‚îÇ     ‚îú‚îÄ‚îÄ queue_manager.js   # Gestion de la file d'attente & Watchdog
  ‚îÇ     ‚îî‚îÄ‚îÄ storage_sync.js    # Gestion des √©v√©nements Storage
  ‚îú‚îÄ‚îÄ /content                 # Les "Capteurs" (Pages Web)
  ‚îÇ     ‚îú‚îÄ‚îÄ content.js         # Script inject√©
  ‚îÇ     ‚îú‚îÄ‚îÄ trigger.css        # Style de la pastille
  ‚îÇ     ‚îî‚îÄ‚îÄ trigger_ui.js      # Logique UI de la pastille
  ‚îî‚îÄ‚îÄ /sidepanel               # La "Vitrine" (UI Principale)
        ‚îú‚îÄ‚îÄ sidepanel.html
        ‚îú‚îÄ‚îÄ sidepanel.js
        ‚îú‚îÄ‚îÄ components.js      # Composants Web simples (Card, List)
        ‚îî‚îÄ‚îÄ styles.css
2.3 Anatomie des Composants (R√¥les & Responsabilit√©s)
A. Le Service Worker (/background) - "Le Chef d'Orchestre"
Composant invisible qui tourne en fond. Il est le seul ma√Ætre en √©criture sur les statuts d'analyse.
R√¥le 1 : Queue Manager. Il g√®re la file d'attente. Il surveille les items PENDING, respecte les quotas de l'API Gemini, et passe les items en PROCESSING puis COMPLETED ou FAILED.
R√¥le 2 : Proxy API. Il effectue les appels fetch vers Gemini pour √©viter les probl√®mes de CORS (Cross-Origin Resource Sharing) qui bloqueraient les Content Scripts.
R√¥le 3 : Watchdog. Via chrome.alarms, il se r√©veille p√©riodiquement (toutes les minutes) pour v√©rifier que la file d'attente n'est pas bloqu√©e (ex: un item coinc√© en "Processing" depuis 5 minutes √† cause d'un crash navigateur).
B. Le Content Script (/content) - "Le Capteur"
Script inject√© dans la page visit√©e (LinkedIn, Apec, PDF Viewer).
Isolation : Utilise le Shadow DOM pour injecter la Pastille sans que le CSS de la page (ex: LinkedIn) ne casse le design du bouton.
Intelligence d'Extraction :
LinkedIn : Capture brute (document.body.innerText). Pas de nettoyage DOM (trop risqu√©).
Autres Sites : Nettoyage intelligent (suppression nav, footer, pubs) via parser.js avant envoi.
PDF : D√©tection de l'URL, envoi de la demande de t√©l√©chargement au Background.
C. Le Side Panel (/sidepanel) - "La Vitrine R√©active"
Interface utilisateur principale.
Passivit√© : Il ne fait aucun calcul complexe. Il est purement r√©actif.
Reactive UI : Il √©coute l'√©v√©nement chrome.storage.onChanged. D√®s que le Background met √† jour un statut ou un r√©sultat, le Side Panel se redessine automatiquement. C'est ce qui donne l'effet "Temps R√©el".
2.4 Strat√©gie de Donn√©es (Stockage Hybride)
C'est le point critique pour la performance (V2). Nous s√©parons les m√©tadonn√©es (l√©g√®res) du contenu (lourd).
1. chrome.storage.local (M√©tadonn√©es & UI)
Utilis√© pour tout ce qui doit d√©clencher une mise √† jour de l'interface (R√©activit√©).
Contenu : Liste des Jobs, Liste des Candidats (ID, Nom, Score, Statut, Date), Param√®tres.
Limite : 5Mo (ou plus avec permission, mais lent si surcharg√©).
Avantage : D√©clenche l'√©v√©nement onChanged √©cout√© par le Side Panel.
2. IndexedDB (Payloads & Fichiers)
Utilis√© pour stocker le contenu brut √† analyser.
Contenu : Le texte complet de la page web, ou la cha√Æne Base64 du PDF (qui peut faire 2, 5 ou 10 Mo).
Avantage : Asynchrone, supporte des centaines de m√©ga-octets, ne ralentit pas le navigateur.
Cycle de vie :
Cr√©ation : Au clic sur la pastille.
Lecture : Par le Service Worker au moment de l'analyse.
Suppression (Flush) : Imm√©diatement apr√®s l'analyse r√©ussie (pour lib√©rer l'espace).
2.5 Flux de Donn√©es (Data Flow) : Sc√©nario "Capture Web"
Voici la s√©quence exacte des √©v√©nements pour une capture :
USER ACTION : Clic sur la Pastille (Content Script).
EXTRACTION (Content) : Le script extrait le texte (Raw ou Cleaned).
MESSAGE (Content -> Background) :
Envoi d'un message runtime.sendMessage({ action: 'ADD_CANDIDATE', payload: ... }).
PERSISTANCE (Background) :
Sauvegarde du contenu brut (texte/base64) dans IndexedDB (Cl√© : payload_<UUID>).
Cr√©ation de l'objet "Candidat" (ID, Nom temporaire, JobID, Status: PENDING) dans chrome.storage.local.
FEEDBACK (Side Panel) :
Le storage.onChanged se d√©clenche.
Le Side Panel (s'il est ouvert) affiche instantan√©ment une nouvelle carte "En attente...".
PROCESSING (Service Worker Loop) :
Le Worker d√©tecte un item PENDING.
Il r√©cup√®re le payload depuis IndexedDB.
Il appelle l'API Gemini.
Il re√ßoit le JSON.
COMPLETION (Background) :
Mise √† jour de l'objet Candidat dans chrome.storage.local (Status: COMPLETED, Score: 85, R√©sum√©...).
Nettoyage : Suppression du payload dans IndexedDB.
UPDATE (Side Panel) :
Le storage.onChanged se d√©clenche.
La carte passe au vert, affiche le score et le r√©sum√©.
2.6 Communication Inter-Modules
Pour √©viter les "Race Conditions" (conflits), nous respectons ces r√®gles strictes :
Content Script -> Background : Toujours via chrome.runtime.sendMessage. Le Content Script n'√©crit jamais directement dans la DB.
Side Panel -> Background : Via chrome.runtime.sendMessage pour les actions (ex: "Delete Candidate", "Prioritize Candidate"). Le Side Panel ne modifie pas la queue lui-m√™me.
Background -> Side Panel : Jamais de communication directe. Le Background met √† jour le Storage, et le Side Panel r√©agit. C'est le pattern "Single Source of Truth".




üíæ MODULE 3 : MOD√àLE DE DONN√âES & STATE MANAGEMENT
3.1 Strat√©gie de Stockage Hybride ("Light UI, Heavy Backend")
Pour r√©soudre le probl√®me de performance li√© aux PDF (Base64) sans bloquer le thread principal, nous divisons le stockage en deux couches distinctes.
Couche	Technologie	R√¥le	Contenu	Persistance
Couche Chaude (UI)	chrome.storage.local	M√©tadonn√©es & Affichage. C'est la source de v√©rit√© pour le Side Panel. Rapide, synchronis√©, d√©clenche les √©v√©nements onChanged.	ID, Nom, Statut, Score, R√©sum√©, ID du Job.	Permanente
Couche Froide (Data)	IndexedDB	Payloads Lourds. Stockage de masse asynchrone pour les fichiers bruts en attente d'analyse.	Texte brut du profil, Cha√Æne Base64 du PDF.	Temporaire (Supprim√© apr√®s analyse)
3.2 Sch√©ma chrome.storage.local (JSON Strict)
C'est la base de donn√©es NoSQL principale. Elle contient 3 collections (Arrays d'objets).
A. pawz_jobs (Les Fiches de Poste)
Permet de g√©rer le multi-contexte (ex: "Dev React" vs "Sales Manager").
code
JSON
[
  {
    "id": "job_1715420000_abc", // Timestamp + Random Suffix
    "title": "Senior Frontend Dev",
    "raw_brief": "Texte complet de la fiche de poste coll√© par l'user...",
    "criteria": {
      "must_have": ["React", "TypeScript", "5 ans exp"],
      "nice_to_have": ["Next.js", "Anglais"]
    },
    "created_at": 1715420000,
    "active": true // Un seul job peut √™tre active:true √† la fois
  }
]
B. pawz_candidates (La File Unifi√©e)
Contient UNIQUEMENT les m√©tadonn√©es l√©g√®res. Pas de gros texte ici.
code
JSON
[
  {
    "id": "cand_987654321", // UUID v4
    "job_id": "job_1715420000_abc", // Cl√© √©trang√®re vers le Job
    "source_url": "https://www.linkedin.com/in/jean-dupont/",
    "source_type": "linkedin_web", // "linkedin_web", "pdf_local", "generic_web"

    // √âtat du candidat
    "status": "pending", // "pending", "processing", "completed", "failed"
    "priority": "normal", // "normal" ou "high" (si user clique sur "Prioriser")

    // Donn√©es affich√©es dans l'UI (Remplies APRES analyse)
    "candidate_name": "Jean Dupont", // "Inconnu" tant que pas analys√©
    "candidate_title": "D√©veloppeur Fullstack",
    "score": 85, // 0 √† 100
    "verdict": "Profil Pertinent",

    // R√©sultat d√©taill√© de l'IA (Texte seulement, reste l√©ger)
    "analysis": {
      "summary": "Candidat solide avec 6 ans d'XP...",
      "strengths": ["Expert React", "Bonne communication"],
      "warnings": ["Pas d'exp√©rience en Management"]
    },

    "error_msg": null, // Si status === 'failed'
    "timestamp_added": 1715420050,
    "timestamp_processed": 1715420060
  }
]
C. pawz_settings (Configuration)
code
JSON
{
  "api_key": "AIzaSy...",
  "model_id": "gemini-2.5-flash",
  "parsing_strategy": "hybrid" // R√©serv√© pour √©volutions futures
}
3.3 Sch√©ma IndexedDB (Base : pawz_db)
Nous utiliserons une seule "Store" (Table) nomm√©e payloads.
L'acc√®s √† IndexedDB √©tant verbeux en JS Vanilla, nous cr√©erons un helper lib/db.js.
Structure de l'objet Payload :
code
JavaScript
{
  "id": "cand_987654321", // M√äME UUID que dans chrome.storage
  "type": "base64",       // "text" ou "base64"
  "content": "JVBERi0xLjQKJ...", // Le contenu lourd (peut faire 10 Mo)
  "created_at": 1715420050
}
3.4 Cycle de Vie de la Donn√©e (State Machine)
Le champ status dans pawz_candidates pilote toute la logique.
√âtat : PENDING (En attente)
D√©clencheur : User clique sur la pastille.
Action :
Payload sauvegard√© dans IndexedDB.
M√©tadonn√©es sauvegard√©es dans Storage.
UI : Carte grise "En attente...".
√âtat : PROCESSING (En cours)
D√©clencheur : Le Service Worker prend le ticket (FIFO ou Priorit√©).
Action :
Lecture du payload depuis IndexedDB.
Envoi √† l'API Gemini.
UI : Carte avec Spinner de chargement ‚è≥.
√âtat : COMPLETED (Succ√®s)
D√©clencheur : R√©ponse 200 OK de Gemini avec JSON valide.
Action :
Mise √† jour des m√©tadonn√©es (Score, Nom, Analyse) dans Storage.
FLUSH (Important) : Suppression du payload dans IndexedDB pour lib√©rer la m√©moire.
UI : Carte color√©e (Vert/Orange/Rouge selon score) + Bouton "Voir d√©tail".
√âtat : FAILED (Erreur)
D√©clencheur : Erreur API (400, 500) ou JSON invalide.
Action :
Mise √† jour error_msg dans Storage.
D√©cision V2 : On garde le payload dans IndexedDB pendant 24h (pour permettre un bouton "R√©essayer"), puis nettoyage automatique.
UI : Carte Rouge ‚ùå avec message d'erreur.
3.5 Interface Helper (lib/db.js)
Pour simplifier la vie du d√©veloppeur (et de l'agent IA), voici la signature des m√©thodes attendues pour interagir avec IndexedDB.
code
JavaScript
// lib/db.js

export const db = {
  // Initialise la DB (Ouvre la connexion, cr√©e le store si inexistant)
  init: async () => { ... },

  // Sauvegarde un payload lourd
  savePayload: async (id, type, content) => { ... },

  // R√©cup√®re un payload pour l'analyse
  getPayload: async (id) => { ... },

  // Supprime un payload (Flush)
  deletePayload: async (id) => { ... },

  // Nettoyage complet (ex: d√©sinstallation ou reset)
  clearAll: async () => { ... }
};
3.6 R√®gles de Gestion & S√©curit√©
Int√©grit√© R√©f√©rentielle : Si un candidat est supprim√© de chrome.storage (Action "Poubelle"), son payload correspondant dans IndexedDB DOIT √™tre supprim√© imm√©diatement.
Quota : Si IndexedDB d√©passe une certaine taille (ex: 500 Mo, peu probable mais possible), le syst√®me doit alerter l'utilisateur ou purger les vieux items FAILED.
Migration V1 : Au premier lancement, le script de migration ne touche pas √† IndexedDB (car la V1 n'avait pas de PDF stock√©s), il migre juste les textes V1 vers le format JSON V2 dans chrome.storage.



‚öôÔ∏è MODULE 4 : LOGIQUE CORE & QUEUE SYSTEM (LE MOTEUR)
4.1 Architecture "Event-Driven" (R√©active)
En Manifest V3, le Service Worker (background.js) est √©ph√©m√®re. Il s'endort apr√®s quelques secondes d'inactivit√©. Nous ne pouvons PAS utiliser de setInterval ou de boucle infinie while(true).
Nous utilisons une architecture r√©active bas√©e sur les √©v√©nements :
Le D√©clencheur Principal : chrome.storage.onChanged.
D√®s que le Content Script ajoute un candidat (Status: PENDING) dans le storage, cet √©v√©nement r√©veille instantan√©ment le Service Worker.
Le Worker lance alors la fonction ma√Ætresse : processQueue().
Le Filet de S√©curit√© (Watchdog) : chrome.alarms.
Une alarme r√©currente (toutes les 1 minute) est configur√©e.
R√¥le : V√©rifier s'il reste des items PENDING qui n'ont pas √©t√© trait√©s (cas o√π le navigateur a tu√© le worker en plein milieu d'une op√©ration ou bug r√©seau). Si oui, elle relance processQueue().
4.2 Algorithme du "Worker Pool" (Gestion de la Concurrence)
L'objectif est de traiter jusqu'√† 3 analyses en parall√®le (pour Gemini Flash) afin d'aller vite, tout en gardant une marge de s√©curit√©.
Logique de la fonction processQueue() :
Lecture de l'√©tat : R√©cup√©rer toute la liste pawz_candidates depuis chrome.storage.local.
Inventaire :
processingItems = Items dont le status est PROCESSING.
pendingItems = Items dont le status est PENDING.
Calcul de Capacit√© :
MAX_CONCURRENT = 3 (Configurable).
slotsAvailable = MAX_CONCURRENT - processingItems.length.
Condition d'Arr√™t :
Si slotsAvailable <= 0 : On arr√™te (le pool est plein).
Si pendingItems.length === 0 : On arr√™te (rien √† faire).
S√©lection (Tri Intelligent) :
On trie pendingItems par ordre de priorit√© :
priority === 'high' (Items prioris√©s par l'utilisateur).
timestamp_added croissant (FIFO - Premier arriv√©, premier servi).
Lancement (Batch) :
On prend les X premiers items (o√π X = slotsAvailable).
Pour chaque item :
On passe son status √† PROCESSING imm√©diatement dans le Storage (pour √©viter qu'une autre ex√©cution parall√®le ne le prenne).
On lance la fonction asynchrone analyzeCandidate(item) sans attendre (no await) pour ne pas bloquer la boucle.
4.3 Pipeline de Traitement (Le Tunnel d'Analyse)
Voici le d√©tail s√©quentiel de la fonction analyzeCandidate(candidate) :
R√©cup√©ration du Payload (IndexedDB) :
Appel √† db.getPayload(candidate.id).
Erreur critique : Si le payload est introuvable (nettoyage agressif ou bug), on marque le candidat en FAILED (Msg: "Donn√©es sources perdues") et on arr√™te.
R√©cup√©ration du Contexte (Storage) :
On r√©cup√®re le Job associ√© via candidate.job_id dans pawz_jobs.
Cela nous donne le Brief, les Must Have et Nice Have.
Appel IA (Gemini Client) :
Construction du Prompt (voir Module 5).
Appel API (fetch vers Google).
Note : Si le payload est un PDF (Base64), on utilise le mode Multimodal de Gemini.
Parsing & Validation :
On re√ßoit le texte de l'IA.
On tente de le parser en JSON (JSON.parse).
On v√©rifie que les champs obligatoires (score, verdict) sont l√†.
Finalisation (Succ√®s) :
Mise √† jour Storage : On met √† jour l'objet candidat :
status: "COMPLETED"
score: 85
analysis: { ...JSON complet... }
Flush (Nettoyage) : Appel √† db.deletePayload(candidate.id) pour vider IndexedDB. C'est imp√©ratif.
4.4 Gestion des Erreurs & Retry
L'API peut √©chouer. Le syst√®me doit √™tre r√©silient.
A. Erreurs Fatales (Pas de Retry)
Types : 400 Bad Request (Requ√™te invalide), JSON Parsing Error (L'IA a hallucin√© le format), Payload Missing.
Action : Status passe √† FAILED. Message d'erreur affich√© en rouge. Le payload est supprim√© d'IndexedDB (inutile de garder un truc cass√©).
B. Erreurs Temporaires (Retry Automatique)
Types : 429 Too Many Requests (Quota d√©pass√©), 500 Server Error, Network Error (Coupure Wifi).
Action :
On ne passe PAS en FAILED.
On repasse le status en PENDING.
On incr√©mente un compteur interne (ex: retry_count).
Si retry_count > 3 -> Passage en FAILED.
Backoff : On planifie une alarme chrome.alarms dans 1 minute pour r√©essayer.
4.5 Interactions Utilisateur (Interruptions)
L'utilisateur peut intervenir sur la file depuis le Side Panel. Le Background doit g√©rer ces cas limites.
A. Suppression ("Poubelle") pendant l'analyse
Sc√©nario : L'item est en PROCESSING (requ√™te partie chez Google). L'utilisateur clique sur "Supprimer".
Action Imm√©diate : Le Side Panel supprime l'item du Storage via un message.
Cons√©quence Background :
La requ√™te Gemini revient 5 secondes plus tard avec le r√©sultat.
Au moment de sauvegarder (analyzeCandidate √©tape 5), le code v√©rifie : Est-ce que cet ID existe toujours dans pawz_candidates ?
R√©ponse : Non.
Action : On jette le r√©sultat √† la poubelle silencieusement. On s'assure juste de bien faire le db.deletePayload(id) pour ne pas laisser de d√©chet dans IndexedDB.
B. Priorisation ("Jump Queue")
Sc√©nario : L'item est 15√®me dans la file. L'utilisateur clique sur "Prioriser" (Fl√®che Haut).
Action Imm√©diate : Le Side Panel met √† jour le champ priority: 'high' dans le Storage.
Cons√©quence Background :
L'√©v√©nement onChanged se d√©clenche.
processQueue() est relanc√©.
Gr√¢ce √† l'√©tape de tri (4.2 point 5), cet item passe en t√™te de liste pour le prochain slot libre.








üß† MODULE 5 : INTELLIGENCE ARTIFICIELLE & PROMPT ENGINEERING
5.1 Configuration du Client Gemini
Nous utilisons l'API Google Generative AI (generativelanguage.googleapis.com).
L'objectif est d'obtenir des r√©ponses d√©terministes (toujours le m√™me r√©sultat pour le m√™me CV) et au format JSON Strict.
A. Mod√®les & R√¥les
Le syst√®me supporte deux modes configurables dans pawz_settings :
Mode "Rapide" (D√©faut) : gemini-1.5-flash (ou gemini-2.0-flash-exp selon dispo).
Usage : 90% des cas. Rapide (< 2s), pas cher, contexte large.
Mode "Expert" (Thinking) : gemini-1.5-pro.
Usage : Pour les profils ex√©cutifs complexes ou les PDF tr√®s lourds. Plus lent, raisonnement plus nuanc√©.
B. Hyperparam√®tres (Configuration Fetch)
Pour garantir la stabilit√© du JSON :
code
JavaScript
const GENERATION_CONFIG = {
  temperature: 0.2,        // Tr√®s bas pour √©viter les hallucinations cr√©atives
  topK: 40,
  topP: 0.95,
  maxOutputTokens: 8192,
  responseMimeType: "application/json" // FORCE la sortie JSON native
};

const SAFETY_SETTINGS = [
  // On d√©sactive les filtres car un CV peut contenir des termes sensibles l√©gitimes
  // (ex: "Membre de l'association Women in Tech", "Nationalit√©", etc.)
  { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
  { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
  { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
  { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
];
5.2 Feature A : Le "Job Parser" (Analyseur de Fiche de Poste)
Fonction : Transformer un texte en vrac (copi√©-coll√© d'un mail ou d'un site carri√®re) en crit√®res structur√©s pour le matching.
Prompt Syst√®me (Job Parser)
code
Text
R√îLE :
Tu es un Expert en Recrutement Technique. Ta mission est de structurer une Fiche de Poste brute.

INSTRUCTION :
Analyse le texte fourni. Extrais les crit√®res cl√©s et s√©pare-les strictement en deux cat√©gories.
Ignore le blabla corporate ("Leader mondial de...", "Babyfoot..."). Concentre-toi sur le besoin op√©rationnel.

R√àGLES D'EXTRACTION :
1. "must_criteria" : Les comp√©tences BLOQUANTES (ex: "Anglais Courant", "5 ans d'XP", "Ma√Ætrise React"). Si le candidat ne l'a pas, il est rejet√©.
2. "nice_criteria" : Les comp√©tences BONUS (ex: "Connaissance de Docker", "Exp√©rience en Start-up").
3. Les crit√®res doivent √™tre courts (max 5 mots).

FORMAT DE SORTIE (JSON) :
{
  "job_title": "Titre normalis√© du poste (ex: Senior Backend Engineer)",
  "summary": "R√©sum√© du poste en 1 phrase percutante.",
  "criteria": {
    "must_have": ["Crit√®re 1", "Crit√®re 2"...],
    "nice_to_have": ["Bonus 1", "Bonus 2"...]
  }
}
5.3 Feature B : L'Analyseur de Candidat (Le C≈ìur)
Fonction : Comparer un profil (Texte ou PDF) avec le Job analys√© pr√©c√©demment.
Gestion Multimodale (Input)
Le prompt est dynamique.
Cas Texte (Web) : On injecte le texte nettoy√© directement dans le prompt.
Cas PDF (Base64) : On envoie le prompt textuel + un objet inlineData contenant le Base64 du PDF (Mime: application/pdf). Gemini "lit" le PDF visuellement.
Prompt Syst√®me (Candidate Analyzer)
code
Text
R√îLE :
Tu es "Pawz", un Recruteur Senior impartial et factuel.

CONTEXTE DU POSTE (JOB) :
[TITRE] : {{job_title}}
[RESUME] : {{job_summary}}
[CRIT√àRES IMP√âRATIFS (MUST)] : {{must_list}}
[CRIT√àRES BONUS (NICE)] : {{nice_list}}

PROFIL DU CANDIDAT :
{{candidate_content_placeholder}}
(Note technique : Si PDF, ce placeholder est vide et le contenu est dans l'attachment).

R√àGLES DE SCORING "HUMAIN" (CRITIQUE) :
1. CUMUL D'EXP√âRIENCE : Ne regarde pas juste le dernier poste. Additionne toutes les exp√©riences pertinentes.
   (Ex: 2 ans "Dev Front" + 3 ans "Lead Tech" = 5 ans d'exp√©rience Technique).
2. DIPL√îME VS R√âALIT√â : L'exp√©rience pratique pr√©vaut sur le dipl√¥me, sauf si le dipl√¥me est un MUST explicite (ex: M√©decin, Avocat).
3. SOFT SKILLS : D√©duis-les du parcours (ex: "Team Lead" = Management, "Freelance" = Autonomie).

√âCHELLE DE NOTATION :
- 0-59 (Non pertinent) : Manque un MUST critique.
- 60-79 (Potentiel) : A les bases, mais manque de s√©niorit√© ou de stack exacte.
- 80-94 (Pertinent) : Fit solide. Coche tous les MUST.
- 95-100 (Jackpot) : Fit parfait + NICE + Parcours d'excellence.

FORMAT DE SORTIE (JSON) :
{
  "candidate_name": "Pr√©nom Nom (ou 'Inconnu')",
  "candidate_title": "Titre actuel d√©tect√©",
  "score": 85, (Entier 0-100)
  "verdict": "Court verdict (ex: Profil Pertinent)",
  "analysis": {
    "summary": "Paragraphe de synth√®se (3 lignes max). Commence par expliquer le score.",
    "strengths": ["Point fort 1", "Point fort 2 (ex: 7 ans d'XP cumul√©e)"],
    "warnings": ["Point de vigilance 1", "Point de vigilance 2"]
  }
}
5.4 Strat√©gie d'Optimisation des Co√ªts (Token Diet)
Gemini facture au "Token" (environ 4 caract√®res). Pour √©viter de payer pour du bruit :
Nettoyage HTML (Web Scraper) :
Avant d'envoyer un profil Web (Apec, Indeed...), le Content Script ex√©cute un parser.js.
Suppression : <nav>, <footer>, <script>, <style>, <svg>, et les blocs de pubs connus.
Objectif : R√©duire la taille du payload de 50% √† 70%.
Truncate (Coupe-Circuit) :
Si le texte nettoy√© d√©passe 25 000 caract√®res (environ 6k tokens, √©norme pour un CV), on coupe la fin.
Pourquoi ? Les infos cl√©s (Exp√©rience, Comp√©tences) sont g√©n√©ralement au d√©but ou au milieu. La fin contient souvent des mentions l√©gales ou du footer inutile.
PDF Natif :
On n'essaie pas d'extraire le texte du PDF en JS (trop verbeux et perte de structure). On laisse Gemini lire le binaire. C'est plus co√ªteux en tokens qu'un texte pur, mais le r√©sultat est bien meilleur sur les CVs complexes (colonnes, graphiques).
5.5 Gestion des Erreurs IA (Hallucinations & Format)
M√™me avec responseMimeType: "application/json", l'IA peut parfois √©chouer.
Le "JSON Cleaner" :
Gemini entoure souvent sa r√©ponse de balises Markdown : ```json { ... } ```.
Le code doit utiliser une Regex pour extraire uniquement ce qui se trouve entre les accolades { et } avant de parser.
Validation de Sch√©ma :
Apr√®s le JSON.parse(), on v√©rifie la pr√©sence des cl√©s vitales : score, verdict, candidate_name.
Si une cl√© manque, on consid√®re l'analyse comme FAILED (ou on met des valeurs par d√©faut "Non d√©tect√©").
Refus de S√©curit√© (Safety Filter) :
Si l'API renvoie une erreur finishReason: "SAFETY", on ne plante pas.
On cr√©e un r√©sultat artificiel : Score 0, Verdict "Bloqu√© par S√©curit√©", et on affiche l'erreur √† l'utilisateur.






üé® MODULE 6 : UI/UX DU SIDE PANEL (LA VITRINE)
6.1 Philosophie & Structure Globale
L'interface bascule d'une "Vue Unique" (V1) √† une architecture Master-Detail (Liste -> D√©tail).
Elle est h√©berg√©e dans sidepanel.html et doit √™tre 100% R√©active : elle ne stocke aucun √©tat local, elle ne fait que refl√©ter chrome.storage.local.
Layout G√©n√©ral (Grid CSS)
L'√©cran est divis√© en 3 zones fixes :
Header (Fixe, 60px) : Navigation et Contexte.
Main Content (Scrollable, Auto) : La zone dynamique (Liste ou Settings).
Detail Overlay (Slide-in) : Le panneau d'analyse qui glisse par-dessus la liste.
Design System (H√©ritage V1)
On conserve l'identit√© pour ne pas perdre les utilisateurs actuels.
Couleurs : Marine #1E40AF (Dominante), Orange #F97316 (Action/Must), Vert #10B981 (Nice/Valid√©).
Typographie : Inter (Google Fonts).
Composants : Boutons arrondis (8px), Cartes avec ombre l√©g√®re via CSS box-shadow.
6.2 Composant A : Le Header Contextuel
C'est le poste de pilotage. Il permet de changer de contexte (Job) sans recharger l'extension.
√âl√©ments HTML :
code
Html
<header class="w-header">
    <div class="brand-area">
        <img src="../assets/logo.svg" class="logo-icon">
        <!-- S√©lecteur de Job (NOUVEAU) -->
        <select id="job-selector" class="job-dropdown">
             <option value="" disabled>Chargement...</option>
             <!-- Options inject√©es dynamiquement : "Dev React", "Sales"... -->
             <option value="new">+ Nouveau Poste</option>
        </select>
    </div>
    <div class="actions-area">
        <button id="btn-settings" class="icon-btn">‚öôÔ∏è</button>
    </div>
</header>
Logique JS (sidepanel.js) :
Au chargement, lire pawz_jobs dans le Storage.
Remplir le <select>.
S√©lectionner l'option o√π active === true.
Event : Au changement (change), mettre √† jour active: true sur le nouveau job dans le Storage. Cela d√©clenchera automatiquement le rafra√Æchissement de la liste des candidats.
6.3 Composant B : La "Queue Dashboard" (Vue Liste)
C'est l'√©cran par d√©faut. Il remplace la vue d'accueil de la V1.
Structure HTML :
code
Html
<main id="view-dashboard" class="w-body">
    <!-- Zone de Filtres / Stats Rapides -->
    <div class="queue-stats">
        <span id="count-pending">‚è≥ 0</span>
        <span id="count-done">‚úÖ 0</span>
    </div>

    <!-- Conteneur de la liste -->
    <div id="candidates-list" class="candidates-container">
        <!-- Template vide (Empty State) -->
        <div class="empty-state">
            <p>Aucun candidat pour ce poste.</p>
            <small>Cliquez sur la pastille Pawz sur LinkedIn pour ajouter des profils.</small>
        </div>

        <!-- Les cartes sont inject√©es ici par JS -->
    </div>
</main>
La Carte Candidat (Item de Liste) :
Elle doit g√©rer 4 √©tats visuels distincts bas√©s sur le champ status.
State PENDING (Gris) :
Affichage : "En attente..."
Actions : Bouton "Poubelle" (Supprimer), Bouton "Fl√®che Haut" (Prioriser - priority: 'high').
State PROCESSING (Bleu/Anim√©) :
Affichage : Spinner CSS rotatif.
Actions : Aucune (ou Annuler).
State COMPLETED (Color√©) :
Affichage : Badge Score (ex: "85%"), Nom du candidat.
Couleur de bordure : Vert (>80), Orange (60-79), Rouge (<60).
Actions : Clic sur la carte enti√®re ouvre le D√©tail.
State FAILED (Rouge) :
Affichage : Ic√¥ne ‚ö†Ô∏è + "Erreur".
Actions : Bouton "Retry" (Relancer) ou "Poubelle".
6.4 Composant C : Le "Detail Overlay" (Vue Analyse)
Au clic sur un candidat termin√©, ce panneau glisse depuis la droite (CSS transform: translateX(0)). Il r√©utilise le code HTML des accord√©ons de la V1.
Structure HTML :
code
Html
<div id="detail-overlay" class="detail-panel hidden">
    <!-- Navigation Rapide (NOUVEAU) -->
    <div class="detail-nav">
        <button id="btn-close-detail">‚Üê Retour</button>
        <div class="nav-arrows">
            <button id="btn-prev-candidate" title="Pr√©c√©dent">‚¨Ü</button>
            <button id="btn-next-candidate" title="Suivant">‚¨á</button>
        </div>
    </div>

    <!-- Contenu Analyse (R√©cup√©r√© de la V1) -->
    <div class="analysis-content">
        <div class="score-header">
            <h1 id="detail-score">85%</h1>
            <span id="detail-verdict">Profil Pertinent</span>
        </div>

        <!-- Accord√©ons -->
        <div class="accordion open">
            <div class="accordion-header">‚úÖ Points Forts</div>
            <ul id="detail-strengths" class="list-check"></ul>
        </div>
        <div class="accordion">
            <div class="accordion-header">‚ö†Ô∏è Vigilance</div>
            <ul id="detail-warnings" class="list-warn"></ul>
        </div>
        <div class="accordion">
            <div class="accordion-header">ü§ñ R√©sum√©</div>
            <p id="detail-summary"></p>
        </div>
    </div>

    <!-- Actions Footer -->
    <div class="detail-footer">
        <a id="btn-open-linkedin" href="#" target="_blank" class="btn-secondary">Voir Profil</a>
        <button id="btn-delete-current" class="btn-danger">Rejeter</button>
    </div>
</div>
Logique de Navigation ("D√©pilage") :
Les boutons Pr√©c√©dent/Suivant sont essentiels pour la productivit√©.
Logique : Ils parcourent le tableau candidates filtr√© par le Job actuel.
UX : Transition instantan√©e (remplacement des donn√©es DOM) sans fermer l'overlay.
6.5 Logique R√©active (Le Moteur JS)
Le fichier sidepanel.js doit suivre ce pattern strict :
code
JavaScript
// 1. √âcouteur Global
chrome.storage.onChanged.addListener((changes, area) => {
    if (area === 'local') {
        // Si les candidats ou le job actif changent, on redessine
        if (changes.pawz_candidates || changes.pawz_jobs) {
            renderDashboard();
        }
    }
});

// 2. Fonction de Rendu (Idempotente)
async function renderDashboard() {
    // A. R√©cup√©rer TOUTES les donn√©es
    const data = await chrome.storage.local.get(['pawz_candidates', 'pawz_jobs']);
    const activeJob = data.pawz_jobs.find(j => j.active);

    if (!activeJob) {
        showEmptyState("S√©lectionnez un poste.");
        return;
    }

    // B. Filtrer les candidats pour ce Job
    const jobCandidates = data.pawz_candidates.filter(c => c.job_id === activeJob.id);

    // C. Trier (Processing > Pending > Completed date desc)
    const sorted = sortCandidates(jobCandidates);

    // D. G√©n√©rer le HTML (Virtual DOM simplifi√© : on vide et on remplit)
    const listContainer = document.getElementById('candidates-list');
    listContainer.innerHTML = '';

    sorted.forEach(candidate => {
        const card = createCandidateCard(candidate); // Cr√©e l'√©l√©ment DOM avec events
        listContainer.appendChild(card);
    });

    // E. Mettre √† jour les compteurs
    updateStats(sorted);
}
6.6 Gestion des Assets (Images)
Attention : Dans un Side Panel, les chemins relatifs peuvent √™tre pi√©geux.
Utiliser chrome.runtime.getURL('assets/logo.svg') pour les images dynamiques.
Pour le HTML statique, /assets/logo.svg fonctionne g√©n√©ralement si la racine est bien d√©finie.



üõ°Ô∏è MODULE 7 : STRAT√âGIE DE MIGRATION & S√âCURIT√â
7.1 Script de Migration (V1 -> V2)
Lors de la mise √† jour, le mod√®le de donn√©es change radicalement (de "Donn√©es Plates" √† "Relationnel").
Nous devons ex√©cuter un script une seule fois au d√©marrage (onInstalled) pour transformer les donn√©es existantes.
Logique du Script (background/migration.js) :
D√©clencheur : chrome.runtime.onInstalled (Raison : update ou install).
V√©rification : On regarde si la cl√© V1 pawz_search_criteria existe dans chrome.storage.local.
Transformation (Mapping) :
Cl√© API : On d√©place pawz_gemini_key (V1) vers pawz_settings.api_key (V2).
Job : On prend l'objet pawz_search_criteria (Brief + Must + Nice) et on cr√©e un Premier Job V2 :
title: "Mon Poste (Import√©)"
raw_brief: Contenu de l'ancien champ brief.
criteria: Contenu des anciens champs mustCriteria et niceCriteria.
active: true.
Nettoyage : Une fois la migration r√©ussie, on supprime les cl√©s V1 (pawz_search_criteria, pawz_gemini_key) pour √©viter que le script ne se relance.
R√©sultat UX : L'utilisateur met √† jour l'extension, ouvre le Side Panel, et retrouve sa configuration pr√™te √† l'emploi sous forme d'un Job actif. Il ne perd rien.
7.2 S√©curit√© & Permissions (Manifest V3)
Google est tr√®s strict. Chaque permission doit √™tre justifi√©e.
Permission	Justification Critique
sidePanel	C≈ìur V2. Remplace l'injection DOM pour l'affichage des r√©sultats.
storage	Stockage des donn√©es candidats et jobs.
unlimitedStorage	Vital. Permet de d√©passer la limite de 5Mo pour IndexedDB (stockage des PDF). Sans √ßa, l'app plante au 2√®me PDF.
scripting	Injection de la Pastille (Trigger) et du CSS associ√©.
activeTab	Lecture du contenu de l'onglet actif au moment du clic.
alarms	Watchdog. Permet au Service Worker de se r√©veiller p√©riodiquement pour d√©bloquer la file d'attente (Retry).
Host Permissions (<all_urls>) :
Indispensable car Pawz est un outil de sourcing "Agnostique". L'utilisateur doit pouvoir sourcer depuis LinkedIn, Apec, un site carri√®re obscur ou une visionneuse PDF locale.
7.3 Le Fichier manifest.json (D√©finitif)
Voici le code exact √† utiliser √† la racine du projet.
code
JSON
{
  "manifest_version": 3,
  "name": "Pawz - Assistant Recruteur AI",
  "version": "2.0.0",
  "description": "Copilote de sourcing asynchrone. Analysez des CVs en masse avec l'IA.",
  "icons": {
    "16": "assets/icon16.png",
    "48": "assets/icon48.png",
    "128": "assets/icon128.png"
  },

  "background": {
    "service_worker": "background/background.js",
    "type": "module"
  },

  "side_panel": {
    "default_path": "sidepanel/sidepanel.html"
  },

  "action": {
    "default_title": "Ouvrir Pawz"
    // Note: Au clic sur l'ic√¥ne extension, le Side Panel s'ouvre par d√©faut
    // gr√¢ce au comportement natif de Chrome si "side_panel" est d√©fini.
  },

  "permissions": [
    "sidePanel",
    "storage",
    "unlimitedStorage",
    "scripting",
    "activeTab",
    "alarms"
  ],

  "host_permissions": [
    "<all_urls>"
  ],

  "web_accessible_resources": [
    {
      "resources": [
        "assets/logo.svg",
        "assets/icon48.png",
        "content/trigger.css"
      ],
      "matches": ["<all_urls>"]
    }
  ],

  "content_security_policy": {
    "extension_pages": "script-src 'self'; object-src 'self'"
  }
}
7.4 Gestion des PDF Locaux (Point de Friction UX)
Chrome bloque par d√©faut l'acc√®s aux URLs file:// pour les extensions. C'est une s√©curit√© navigateur qu'on ne peut pas contourner par code.
La Strat√©gie UX :
D√©tection : Au d√©marrage du Side Panel, on appelle chrome.extension.isAllowedFileSchemeAccess().
Feedback :
Si false : On affiche une banni√®re d'alerte orange en haut du Dashboard : "Pour analyser vos PDF locaux, veuillez activer l'acc√®s aux fichiers."
Le bouton pointe vers chrome://extensions/?id=ID_EXTENSION.
Fallback : Si l'utilisateur tente d'ajouter un PDF local sans cette permission, la capture √©chouera. On doit catcher l'erreur et afficher une notification explicite : "Permission manquante : Activez l'acc√®s aux fichiers dans les r√©glages Chrome."




````
